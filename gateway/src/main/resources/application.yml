# ============================================
# gateway - 本地最小配置
# ============================================

server:
  port: 8080  # 本地固定 8080

spring:
  application:
    name: gateway
  config:
    import:
      - optional:nacos:application.yml
      - optional:nacos:gateway.yml

  cloud:
    nacos:
      discovery:
        server-addr: ${NACOS_SERVER_ADDR:nacos:8848}
      config:
        server-addr: ${NACOS_SERVER_ADDR:nacos:8848}
        file-extension: yml

    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origin-patterns: "*"
            allowed-methods:
              - "GET"
              - "POST"
              - "PUT"
              - "DELETE"
              - "OPTIONS"
            allowed-headers: "*"
            allow-credentials: true
      routes:
        # ==================== 業務 API 路由 ====================
        - id: auth-service-route
          uri: lb://auth-service
          predicates:
            - Path=/api/auth/**
          filters:
            - StripPrefix=1

        - id: user-service-route
          uri: lb://user-service
          predicates:
            - Path=/api/users/**
          filters:
            - StripPrefix=1

        - id: product-service-route
          uri: lb://product-service
          predicates:
            - Path=/api/products/**
          filters:
            - StripPrefix=1

        - id: cart-service-route
          uri: lb://cart-service
          predicates:
            - Path=/api/cart/**
          filters:
            - StripPrefix=1

        - id: order-service-route
          uri: lb://order-service
          predicates:
            - Path=/api/orders/**
          filters:
            - StripPrefix=1

        - id: search-service-route
          uri: lb://search-service
          predicates:
            - Path=/api/search/**
          filters:
            - StripPrefix=1

        - id: coupon-service-route
          uri: lb://coupon-service
          predicates:
            - Path=/api/coupons/**
          filters:
            - StripPrefix=1

        - id: payment-service-route
          uri: lb://payment-service
          predicates:
            - Path=/api/payments/**
          filters:
            - StripPrefix=1

        # 特賣下單路由 (order-service) — 必須在 promotion-service-route 之前
        - id: flash-sale-order-route
          uri: lb://order-service
          predicates:
            - Path=/api/promotions/flash-sales/*/submit, /api/promotions/flash-sales/result
          filters:
            - StripPrefix=1

        - id: promotion-service-route
          uri: lb://promotion-service
          predicates:
            - Path=/api/promotions/**
          filters:
            - StripPrefix=1

        # ==================== OAuth2 路由 ====================
        - id: oauth2-login-route
          uri: lb://auth-service
          predicates:
            - Path=/oauth2/authorization/**

        - id: oauth2-callback-route
          uri: lb://auth-service
          predicates:
            - Path=/login/oauth2/code/**

        # ==================== API 文件路由 ====================
        - id: auth-api-docs-route
          uri: lb://auth-service
          predicates:
            - Path=/v3/api-docs/auth-service
          filters:
            - RewritePath=/v3/api-docs/auth-service, /v3/api-docs

        - id: user-api-docs-route
          uri: lb://user-service
          predicates:
            - Path=/v3/api-docs/user-service
          filters:
            - RewritePath=/v3/api-docs/user-service, /v3/api-docs

        - id: product-api-docs-route
          uri: lb://product-service
          predicates:
            - Path=/v3/api-docs/product-service
          filters:
            - RewritePath=/v3/api-docs/product-service, /v3/api-docs

        - id: cart-api-docs-route
          uri: lb://cart-service
          predicates:
            - Path=/v3/api-docs/cart-service
          filters:
            - RewritePath=/v3/api-docs/cart-service, /v3/api-docs

        - id: order-api-docs-route
          uri: lb://order-service
          predicates:
            - Path=/v3/api-docs/order-service
          filters:
            - RewritePath=/v3/api-docs/order-service, /v3/api-docs

        - id: search-api-docs-route
          uri: lb://search-service
          predicates:
            - Path=/v3/api-docs/search-service
          filters:
            - RewritePath=/v3/api-docs/search-service, /v3/api-docs

        - id: coupon-api-docs-route
          uri: lb://coupon-service
          predicates:
            - Path=/v3/api-docs/coupon-service
          filters:
            - RewritePath=/v3/api-docs/coupon-service, /v3/api-docs

        - id: payment-api-docs-route
          uri: lb://payment-service
          predicates:
            - Path=/v3/api-docs/payment-service
          filters:
            - RewritePath=/v3/api-docs/payment-service, /v3/api-docs

        - id: promotion-api-docs-route
          uri: lb://promotion-service
          predicates:
            - Path=/v3/api-docs/promotion-service
          filters:
            - RewritePath=/v3/api-docs/promotion-service, /v3/api-docs



  security:
    oauth2:
      resourceserver:
        jwt:
          jwk-set-uri: http://auth-service:9000/oauth2/jwks
