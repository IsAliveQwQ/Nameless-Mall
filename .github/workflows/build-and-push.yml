# =================================================================
# == Nameless Mall CI/CD
# == æ¯å€‹æœå‹™ç¨ç«‹ Jobï¼ŒGitHub è‡ªå‹•ä¸¦è¡ŒåŸ·è¡Œ
# =================================================================

name: Build and Deploy All

on:
  push:
    branches: [ "main" ]
    # Explicitly include backend paths to ensure triggering
    paths:
      - 'services/**'
      - 'gateway/**'
      - 'common/**'
      - 'scripts/**'
      - 'nacos-config/**'
      - 'nginx/**'
      - 'pom.xml'
      - '.github/workflows/**'

  workflow_dispatch:

env:
  REGISTRY: asd902648

jobs:
  # =================================================================
  # éšŽæ®µé›¶ï¼šç’°å¢ƒæ¸…ç† (ç¢ºä¿ä¹‹å‰çš„ç†±ä¿®å¾©ä¸è¢«èˆŠå¿«å–å¹²æ“¾)
  # =================================================================
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Force Purge Artifacts and Runs
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ§¹ Step 1: Deleting all individual artifacts..."
          gh api repos/${{ github.repository }}/actions/artifacts --paginate --jq '.artifacts[].id' > art_ids.txt || echo ""
          
          if [ -s art_ids.txt ]; then
            echo "Found $(wc -l < art_ids.txt) artifacts. Deleting..."
            while read -r id; do
              gh api -X DELETE repos/${{ github.repository }}/actions/artifacts/$id || true
            done < art_ids.txt
          fi

          echo "ðŸ—‘ï¸ Step 2: Deleting all old runs (Bulk purge)..."
          gh run list --repo ${{ github.repository }} --limit 100 --json databaseId -q '.[].databaseId' > run_ids.txt
          while read -r id; do
            if [ "$id" != "${{ github.run_id }}" ]; then
              gh run delete $id --repo ${{ github.repository }} || true
            fi
          done < run_ids.txt
          
          echo "âœ… Quota recovery finished."

  # =================================================================
  # éšŽæ®µä¸€ï¼šå¾Œç«¯ Matrix æ§‹å»º (Maven + Docker ä¸€é«”åŒ–)
  # é¿å… Artifact å­˜å„²é…é¡å•é¡Œ
  # =================================================================
  maven-build:
    needs: cleanup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: gateway
            path: ./gateway
            module: gateway
          - service: auth-service
            path: ./services/auth-service
            module: services/auth-service
          - service: user-service
            path: ./services/user-service
            module: services/user-service
          - service: product-service
            path: ./services/product-service
            module: services/product-service
          - service: cart-service
            path: ./services/cart-service
            module: services/cart-service
          - service: order-service
            path: ./services/order-service
            module: services/order-service
          - service: search-service
            path: ./services/search-service
            module: services/search-service
          - service: coupon-service
            path: ./services/coupon-service
            module: services/coupon-service
          - service: payment-service
            path: ./services/payment-service
            module: services/payment-service
          - service: promotion-service
            path: ./services/promotion-service
            module: services/promotion-service

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Inject Auth Keys from Secrets
        if: matrix.service == 'auth-service'
        run: |
          echo "${{ secrets.AUTH_PRIVATE_KEY }}" > services/auth-service/src/main/resources/private_key.pem
          echo "${{ secrets.AUTH_PUBLIC_KEY }}" > services/auth-service/src/main/resources/public_key.pem

      - name: Build ${{ matrix.service }} with Maven
        run: |
          # å…ˆæ§‹å»º common ä¾è³´
          mvn clean install -pl common/common-core -DskipTests -q
          # æ§‹å»º API æ¨¡çµ„ (å¦‚æžœå­˜åœ¨)
          if [ -d "services/${{ matrix.service }}-api" ]; then
            mvn clean install -pl services/${{ matrix.service }}-api -DskipTests -q || true
          fi
          # å¦‚æžœæ˜¯ gatewayï¼Œåªæ§‹å»º gateway
          if [ "${{ matrix.service }}" = "gateway" ]; then
            mvn clean package -pl gateway -DskipTests -q
          else
            # æ§‹å»ºæœå‹™æœ¬èº«
            mvn clean package -pl ${{ matrix.module }} -DskipTests -q -am
          fi

      - name: Prepare JAR for Docker
        run: |
          mkdir -p ${{ matrix.path }}/target
          cp ${{ matrix.path }}/target/*.jar ${{ matrix.path }}/app.jar 2>/dev/null || true
          ls -la ${{ matrix.path }}/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.path }}
          push: true
          tags: ${{ env.REGISTRY }}/${{ matrix.service }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max



  # =================================================================
  # éšŽæ®µå››ï¼šElasticsearch æ§‹å»º
  # =================================================================
  elasticsearch-build:
    needs: cleanup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Elasticsearch
        uses: docker/build-push-action@v5
        with:
          context: ./elasticsearch
          push: true
          tags: ${{ env.REGISTRY }}/elasticsearch:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # =================================================================
  # éšŽæ®µäº”ï¼šéƒ¨ç½² 
  # =================================================================
  deploy:
    # ä¾è³´ï¼šå¿…é ˆæ‰€æœ‰æ§‹å»º Job æˆåŠŸå¾Œæ‰åŸ·è¡Œéƒ¨ç½²
    needs: [cleanup, maven-build, elasticsearch-build]
    if: always() && !contains(needs.maven-build.result, 'failure')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Sync configuration
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          source: "docker-compose.yml,sql/*,nginx/*,nacos-config/*,scripts/*"
          target: "~/mall-deployment"

      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          RMQ_USERNAME: ${{ secrets.RMQ_USERNAME }}
          RMQ_PASSWORD: ${{ secrets.RMQ_PASSWORD }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          envs: MYSQL_ROOT_PASSWORD,DB_USER,DB_PASS,RMQ_USERNAME,RMQ_PASSWORD,GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET
        # é‡è¦ï¼šè…³æœ¬ä¸­çš„ secrets.AUTH_PRIVATE_KEY, AUTH_PUBLIC_KEY åƒ…åœ¨ build éšŽæ®µç”¨ï¼Œrun éšŽæ®µä¸éœ€è¦ï¼Œå› ç‚ºå·²ç¶“æ‰“åŒ…é€² jar
          script: |
            cd ~/mall-deployment
            
            # ç”Ÿæˆç’°å¢ƒè®Šæ•¸
            cat > .env << EOF
            MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD
            DB_USER=$DB_USER
            DB_PASS=$DB_PASS
            RABBITMQ_USER=$RMQ_USERNAME
            RABBITMQ_PASS=$RMQ_PASSWORD
            GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
            GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET
            EOF
            
            # 1. ç¢ºä¿åŸºç¤Žé¡åƒå·²æ‹‰å–
            docker compose pull
            
            # 1.5 ä¸Šå‚³ Nacos é…ç½® (ç¢ºä¿ Config ä¸æ¼‚ç§»)
            echo "ðŸ”„ Updating Nacos Configs using Python script..."
            # ç¢ºä¿ Python ç’°å¢ƒè£æœ‰ requests
            pip3 install requests --quiet
            # å˜—è©¦ç­‰å¾… Nacos ç«¯å£
            timeout 30s bash -c 'until echo > /dev/tcp/127.0.0.1/8848; do sleep 1; done' 2>/dev/null || echo "âš ï¸ Nacos port check timeout"
            python3 scripts/push_nacos_config.py --host 127.0.0.1:8848 --dir ./nacos-config
            
            # 2. éšŽæ®µæ€§å•Ÿå‹• - é™ä½Ž CPU å³°å€¼ (Startup Storm Mitigation)
            echo "ðŸš€ Starting Auth Service (Batch 1)..."
            docker compose up -d auth-service
            sleep 30
            
            echo "ðŸš€ Starting Core Services (Batch 2)..."
            docker compose up -d user-service product-service gateway seata-server nginx cerebro
            sleep 45
            
            echo "ðŸš€ Starting Business Services (Batch 3)..."
            docker compose up -d order-service cart-service coupon-service payment-service search-service promotion-service
            
            # 3. åŸ·è¡Œè³‡æ–™åº«è£œä¸ (Hotfix for @TableLogic)
            echo "ðŸ”§ Applying SQL Patches..."
            docker exec -i mysql mysql -u root -p$MYSQL_ROOT_PASSWORD mall_order -e "ALTER TABLE orders ADD COLUMN IF NOT EXISTS is_deleted TINYINT(1) DEFAULT 0 COMMENT 'é‚è¼¯åˆªé™¤' AFTER updated_at;" || echo "âš ï¸ Order patch skipped"
            docker exec -i mysql mysql -u root -p$MYSQL_ROOT_PASSWORD mall_coupon -e "ALTER TABLE coupon_templates ADD COLUMN IF NOT EXISTS is_deleted TINYINT(1) DEFAULT 0 COMMENT 'é‚è¼¯åˆªé™¤' AFTER updated_at;" || echo "âš ï¸ Coupon patch skipped"

            # 4. é©—è­‰
            echo "âœ… All batches triggered and patches applied!"
             docker ps --format "table {{.Names}}\t{{.Status}}"

            
            # èƒŒæ™¯æ¸…ç† (ä¸é˜»å¡žéƒ¨ç½²)
            nohup docker image prune -f > /dev/null 2>&1 &
            
            echo "âœ… Deploy completed with staggered startup!"
